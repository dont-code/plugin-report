(self.webpackChunkreport_tester=self.webpackChunkreport_tester||[]).push([[2986],{12986:(Ce,R,p)=>{p.r(R),p.d(R,{ReportDisplayComponent:()=>v,ReportEntityComponent:()=>P,ReportModule:()=>T,ReportTableComponent:()=>E});var g=p(57863),e=p(30549),c=p(17401),l=p(67138),S=p(92256);class V{constructor(t,n){this.modelMgr=t,this.data=new S.ReplaySubject(1),this.option=new S.ReplaySubject(1),this.targetType=null,this.config=n}setConfig(t){this.config=t}setTargetType(t){this.targetType=t}translatedGraphType(){if(null!=this.config?.type)return this.config.type.toLowerCase()}changeGraphType(t){if(null==this.config)throw new Error("No config to change type to "+t);this.config.type=t}dataObservable(){return this.data.asObservable()}optionObservable(){return this.option.asObservable()}updateSourceData(t){if(null==this.config)throw new Error("Cannot process source data without graph configuration");const n="Dollar"==this.targetType||"Euro"==this.targetType||"Other currency"==this.targetType;let i=!1;if("Table"!=this.config.type){const r=[],a=[];let u=1;const D=new l.DataTransformationInfo,m="Pie"!=this.config.type;let _=this.labelFieldName;null!=this.config.by&&(_=this.config.by);for(const d of t.entities){let y;null!=_?(d[_]instanceof Date&&(i=!0),y=this.translateDateValue(d[_])):(y=u,u++);const h=this.translateDateValue(this.modelMgr.extractValue(d[this.config.of],D));let s=a.indexOf(y);-1==s&&a.push(y),m?-1==s?r.push({x:y,y:h,src:d[this.config.of]}):"number"==typeof r[s].y?(r[s].y=null!=h?r[s].y+h:r[s].y,r[s].src=this.modelMgr.modifyValues(r[s].src,d[this.config.of],D,(b,w)=>null==b?w:null==w?b:b+w)):null==r[s].y?(r[s].y=h,r[s].src=d[this.config.of]):r.push({x:y,y:h,src:d[this.config.of]}):-1==s?r.push(h):"number"==typeof r[s]?r[s]=null!=h?r[s]+h:r[s]:null==r[s]?r[s]=h:(s=-1,a.push(y),r.push(h))}const C={datasets:[{label:this.config.of,data:r}]},f={plugins:{}};if(f.plugins.title={align:"center",position:"top",display:!0,text:this.config.title},(!n||!m)&&(C.labels=a),i&&(f.scales={x:{type:"time"}}),f.plugins.autocolors="Line"!=this.config.type?{mode:"data",offset:2}:{mode:"dataset",offset:2},n&&(f.plugins.tooltip={callbacks:{label:function(d){return null!=d.raw?.src?.currencyCode?Intl.NumberFormat(void 0,{style:"currency",currency:d.raw.src.currencyCode}).format(d.parsed.y):d.parsed.y}}}),"Bar"==this.config.type);else if("Pie"==this.config.type){const d=C;for(const y of d.datasets)y.hoverOffset=20}this.data.next(C),this.option.next(f)}}setLabelFieldName(t){this.labelFieldName=t}translateDateValue(t){return t instanceof Date?t.valueOf():t}}var I=p(62833);const A=["fullView"];function j(o,t){if(1&o&&(e.\u0275\u0275element(0,"p-chart",3),e.\u0275\u0275pipe(1,"async"),e.\u0275\u0275pipe(2,"async")),2&o){const n=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("data",e.\u0275\u0275pipeBind1(1,3,n.chartData$))("options",e.\u0275\u0275pipeBind1(2,5,n.chartOption$))("type",n.type)}}function B(o,t){1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275text(1,"Please define a graph type"),e.\u0275\u0275elementContainerEnd())}function L(o,t){if(1&o&&(e.\u0275\u0275template(0,j,3,7,"p-chart",1),e.\u0275\u0275template(1,B,2,0,"ng-container",2)),2&o){const n=e.\u0275\u0275nextContext();e.\u0275\u0275property("ngIf",void 0!==n.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",void 0===n.type)}}class v extends c.AbstractDynamicComponent{constructor(t,n){super(),this.modelMgr=t,this.schemaMgr=n,this.title="",this.provider=null,this.graphModelPointer=null,this.dataTransformer=new V(t),this.chartData$=this.dataTransformer.dataObservable(),this.chartOption$=this.dataTransformer.optionObservable()}providesTemplates(){return new c.TemplateList(null,this.fullView,this.fullView)}canProvide(t){return new c.PossibleTemplateList(!1,!0,!0)}setValue(t){super.setValue(t),this.dataTransformer.updateSourceData(t)}initCommandFlow(t,n){this.provider=t,this.graphModelPointer=n;const i=this.provider.getJsonAt(n.position);this.dataTransformer.setConfig(i),this.type=this.dataTransformer.translatedGraphType(),this.title=i.title;const r=l.DontCodeModelPointer.parentPosition(this.graphModelPointer.containerPosition);if(null!=r){const a=this.modelMgr.findTargetOfProperty(l.DontCodeModel.APP_REPORTS_FOR_NODE,r);if(null!=a&&null!=a.value){if(this.entityNamePropertyName=this.modelMgr.guessNamePropertyOfElement(null,a.value.fields),null!=i.of)for(const u of Object.values(a.value.fields))if(u[l.DontCodeModel.APP_FIELDS_NAME_NODE]==i.of){this.dataTransformer.setTargetType(u[l.DontCodeModel.APP_FIELDS_TYPE_NODE]);break}}else this.entityNamePropertyName=null}null!=this.entityNamePropertyName&&this.dataTransformer.setLabelFieldName(this.entityNamePropertyName)}handleChange(t){t.position==this.graphModelPointer?.position?t.type===l.ChangeType.DELETE?(this.dataTransformer.setConfig(),this.type=void 0):(this.dataTransformer.setConfig(t.value),this.type=this.dataTransformer.translatedGraphType()):t.position==this.graphModelPointer?.position+"/"+l.DontCodeModel.APP_REPORTS_DISPLAY_TYPE_NODE&&(t.type===l.ChangeType.DELETE?(this.dataTransformer.setConfig(),this.type=void 0):(this.dataTransformer.changeGraphType(t.value),this.type=this.dataTransformer.translatedGraphType()))}}v.\u0275fac=function(t){return new(t||v)(e.\u0275\u0275directiveInject(l.DontCodeModelManager),e.\u0275\u0275directiveInject(l.DontCodeSchemaManager))},v.\u0275cmp=e.\u0275\u0275defineComponent({type:v,selectors:[["dontcode-report-field"]],viewQuery:function(t,n){if(1&t&&e.\u0275\u0275viewQuery(A,7),2&t){let i;e.\u0275\u0275queryRefresh(i=e.\u0275\u0275loadQuery())&&(n.fullView=i.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:2,vars:0,consts:[["fullView",""],[3,"data","options","type",4,"ngIf"],[4,"ngIf"],[3,"data","options","type"]],template:function(t,n){1&t&&e.\u0275\u0275template(0,L,2,2,"ng-template",null,0,e.\u0275\u0275templateRefExtractor)},dependencies:[g.NgIf,I.UIChart,g.AsyncPipe]});class N{constructor(t,n,i,r){this.modelMgr=t,this.affectedColumns=n,this.groupType=i,this.entityPosition=r}postLoadingTransformation(t){if(null==this.groupType.show)return t;const n=new Array,i=this.calculateFieldMapping(),r=new Map;for(const a of t){const u=structuredClone(a);u[this.groupType.show.valueOf()]=this.calculateRelevantColumn(a,i,r),n.push(u)}return n}calculateRelevantColumn(t,n,i){let r,a,u;const D=this.entityPosition.subItemPointer(l.DontCodeModel.APP_FIELDS_NODE);for(const m of this.affectedColumns){let _=i.get(m);null==_&&(_=new l.DataTransformationInfo,i.set(m,_));const C=n.get(m);if(null==C)return;const f=this.modelMgr.extractValue(t[m],_,D.subItemPointer(C));null==r||null==a?(r=t[m],a=f,u=m):this.groupType.show==l.DontCodeReportGroupShowType.OnlyLowest?f<a&&(r=t[m],a=f,u=m):f>a&&(r=t[m],a=f,u=m)}return u}calculateFieldMapping(){const t=this.modelMgr.findAtPosition(this.entityPosition.position,!1),n=new Map;if(null!=t.fields)for(const i of Object.entries(t.fields))null!=i[1].name&&n.set(i[1].name,i[0]);return n}}const $=["defaultdisplay"];function G(o,t){1&o&&e.\u0275\u0275elementContainer(0)}const M=function(o){return{fieldType:o}};function Q(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",6),e.\u0275\u0275template(1,G,1,0,"ng-container",7),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext();e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",i.subFieldFullViewTemplate(n))("ngTemplateOutletContext",e.\u0275\u0275pureFunction1(2,M,n.type))}}function J(o,t){1&o&&e.\u0275\u0275elementContainer(0)}function Y(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",8),e.\u0275\u0275template(1,J,1,0,"ng-container",7),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext();e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",i.subFieldFullViewTemplate(n))("ngTemplateOutletContext",e.\u0275\u0275pureFunction1(2,M,n.type))}}function k(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",3),e.\u0275\u0275template(1,Q,2,4,"div",4),e.\u0275\u0275template(2,Y,2,4,"div",5),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","Table"===n.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","Table"!==n.type)}}function H(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",9),e.\u0275\u0275text(1),e.\u0275\u0275elementEnd()),2&o){const n=t.fieldType;e.\u0275\u0275advance(1),e.\u0275\u0275textInterpolate1(" No components for ",n," ")}}class P extends c.PluginBaseComponent{constructor(t,n,i,r,a,u){super(t,r,a),this.entityService=n,this.valueService=i,this.modelMgr=u,this.title="No Title",this.store=null,this.dataLoading=!1,this.reportDescription=null,this.reportEntityData=new l.DontCodeStorePreparedEntities([]),this.targetEntityPointer=null,this.fieldTypeTransformer=null,null==this.modelMgr&&(this.modelMgr=l.dtcde.getModelManager())}initCommandFlow(t,n){if(super.initCommandFlow(t,n),!this.entityPointer)throw new Error("Cannot listen to changes without knowing a base position");this.reportDescription=t.getJsonAt(this.entityPointer.position),this.initTargetEntity(),this.decomposeJsonToMultipleChanges(this.entityPointer,this.reportDescription),this.initChangeListening(!0)}initTargetEntity(){if(null==this.entityPointer)return;const t=this.valueService.findTargetOfProperty("for",this.entityPointer.position);null!=t&&null!=this.provider&&(this.targetEntityPointer=this.provider.getSchemaManager().generateSchemaPointer(t.pointer),this.store=this.entityService.retrieveListManager(this.targetEntityPointer,this.valueService.findAtPosition(t.pointer,!1)),this.pluginHelper.initOtherChangeListening(!0,this.targetEntityPointer))}ngAfterViewInit(){super.ngAfterViewInit(),this.loadTargetEntities()}loadTargetEntities(){if(!this.entityPointer||!this.provider)throw new Error("Cannot create subcomponents before initCommandFlow is called");null!=this.store&&(this.dataLoading=!0,this.calculateTransformer(),this.store.searchAndPrepareEntities(this.reportDescription?.sortedBy,this.reportDescription?.groupedBy,this.fieldTypeTransformer??void 0).then(()=>{console.debug("Loaded entities"),this.reportEntityData=this.store?.prepared??new l.DontCodeStorePreparedEntities([]),this.dataLoading=!1,this.updateSubFieldsValues(),this.ref.markForCheck(),this.ref.detectChanges()},t=>{this.dataLoading=!1}))}updateSubFieldsValues(){for(const t of this.fields)null!=t.component&&t.component.setValue(this.store)}providesTemplates(t){throw new Error("Method not implemented.")}canProvide(t){throw new Error("Method not implemented.")}setValue(t){console.debug("setValue() called for ReportEntity")}getValue(){console.debug("getValue() called for ReportEntity")}handleChange(t){t?.pointer?.positionInSchema===l.DontCodeModel.APP_REPORTS_DISPLAY?this.updateSubFieldsWithChange(t,l.DontCodeModel.APP_REPORTS_DISPLAY_NODE).then(n=>{null!=n&&(this.updateSubFieldsValues(),this.ref.markForCheck(),this.ref.detectChanges())}).catch(n=>{console.error(n)}):t?.pointer?.positionInSchema===l.DontCodeModel.APP_REPORTS_TITLE?this.title=t.type===l.ChangeType.DELETE?"":t.value:null!=this.targetEntityPointer&&null!=t?.pointer?.isSubItemOf(this.targetEntityPointer)&&this.loadTargetEntities()}subFieldFullViewTemplate(t){let n=super.subFieldFullViewTemplate(t);return null==n&&(n=this.defaultTemplate),n}calculateTransformer(){if(this.fieldTypeTransformer=null,null!=this.reportDescription&&null!=this.targetEntityPointer&&null!=this.provider&&null!=this.reportDescription.groupedBy){const t=Object.values(this.reportDescription.groupedBy)[0]?.of;if(null!=t){const n=this.valueService.findAtPosition(this.targetEntityPointer.position,!1);if(null!=n.fields){const i=new Array;for(const r of Object.values(n.fields)){if(r.name==t)return;r.type==t&&i.push(r.name)}0!=i.length&&(this.fieldTypeTransformer=new N(this.modelMgr,i,Object.values(this.reportDescription.groupedBy)[0],this.targetEntityPointer))}}}}}P.\u0275fac=function(t){return new(t||P)(e.\u0275\u0275directiveInject(c.ComponentLoaderService),e.\u0275\u0275directiveInject(c.EntityStoreService),e.\u0275\u0275directiveInject(c.ValueService),e.\u0275\u0275directiveInject(e.Injector),e.\u0275\u0275directiveInject(e.ChangeDetectorRef),e.\u0275\u0275directiveInject(l.DontCodeModelManager,8))},P.\u0275cmp=e.\u0275\u0275defineComponent({type:P,selectors:[["dontcode-report-entity"]],viewQuery:function(t,n){if(1&t&&e.\u0275\u0275viewQuery($,5),2&t){let i;e.\u0275\u0275queryRefresh(i=e.\u0275\u0275loadQuery())&&(n.defaultTemplate=i.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:7,vars:2,consts:[[1,"p-fluid"],["class","field grid",4,"ngFor","ngForOf"],["defaultdisplay",""],[1,"field","grid"],["class","col-12",4,"ngIf"],["class","col-12 md:col-6",4,"ngIf"],[1,"col-12"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"col-12","md:col-6"],[1,"col-12","md:col-10"]],template:function(t,n){1&t&&(e.\u0275\u0275element(0,"dtcde-dynamic"),e.\u0275\u0275elementStart(1,"h1"),e.\u0275\u0275text(2),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementStart(3,"div",0),e.\u0275\u0275template(4,k,3,2,"div",1),e.\u0275\u0275elementEnd(),e.\u0275\u0275template(5,H,2,1,"ng-template",null,2,e.\u0275\u0275templateRefExtractor)),2&t&&(e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate1("Report ",n.title,""),e.\u0275\u0275advance(2),e.\u0275\u0275property("ngForOf",n.getSubFields()))},dependencies:[g.NgForOf,g.NgIf,g.NgTemplateOutlet,c.DynamicInsertPoint]});var O=p(11749),U=p(72097),K=p(91083),W=p.n(K);class z{constructor(){O.Chart.register(W()),O._adapters._date.override(U.StdDateAdapter.chartJsStandardAdapter())}getConfiguration(){return{plugin:{id:"ReportPlugin","display-name":"Implements the Dont-code standard report model.",version:"1.0.0"},"preview-handlers":[{location:{parent:l.DontCodeModel.APP_REPORTS,id:""},class:{name:"ReportEntityComponent",source:"report"}},{location:{parent:l.DontCodeModel.APP_REPORTS_DISPLAY,id:"type",values:["Table"]},class:{name:"ReportTableComponent",source:"report"}},{location:{parent:l.DontCodeModel.APP_REPORTS_DISPLAY},class:{name:"ReportDisplayComponent",source:"report"}}]}}pluginInit(t){}}var X=p(27022),Z=p(46674),x=p(72655),q=p(3134),F=p(51411);const ee=["fullView"];function te(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"th",7),e.\u0275\u0275text(1),e.\u0275\u0275element(2,"p-sortIcon",8),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275propertyInterpolate1("id","header-",n.header,""),e.\u0275\u0275property("pSortableColumn",n.field),e.\u0275\u0275advance(1),e.\u0275\u0275textInterpolate1(" ",n.header," "),e.\u0275\u0275advance(1),e.\u0275\u0275property("field",n.field)}}function ne(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"tr"),e.\u0275\u0275template(1,te,3,4,"th",6),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",n)}}function oe(o,t){1&o&&e.\u0275\u0275elementContainer(0)}function ie(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275template(1,oe,1,0,"ng-container",11),e.\u0275\u0275elementContainerEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext().$implicit,r=e.\u0275\u0275nextContext(2);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",r.templateOf(n,i[n.field]))}}function re(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"span",12),e.\u0275\u0275pipe(2,"beautifier"),e.\u0275\u0275text(3),e.\u0275\u0275pipe(4,"beautifier"),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext().$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275propertyInterpolate("pTooltip",e.\u0275\u0275pipeBind1(2,2,i[n.field])),e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate(e.\u0275\u0275pipeBind2(4,4,i[n.field],50))}}function ae(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"td"),e.\u0275\u0275template(1,ie,2,1,"ng-container",10),e.\u0275\u0275template(2,re,5,7,"ng-container",10),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",n.component),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",!n.component)}}function le(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"tr"),e.\u0275\u0275template(1,ae,3,2,"td",9),e.\u0275\u0275elementEnd()),2&o){const n=t.columns;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",n)}}function se(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"tr",14)(1,"td",15)(2,"span"),e.\u0275\u0275text(3),e.\u0275\u0275elementEnd()()()),2&o){const n=e.\u0275\u0275nextContext(),i=n.columns,r=n.$implicit,a=e.\u0275\u0275nextContext(2);e.\u0275\u0275advance(1),e.\u0275\u0275property("colSpan",i.length),e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate(r[a.groupRowsBy])}}function pe(o,t){if(1&o&&e.\u0275\u0275template(0,se,4,2,"tr",13),2&o){const n=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("ngIf",n.areGroupsDefined())}}function ce(o,t){1&o&&e.\u0275\u0275elementContainer(0)}function de(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"div"),e.\u0275\u0275text(2),e.\u0275\u0275template(3,ce,1,0,"ng-container",11),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext().$implicit,r=e.\u0275\u0275nextContext(4);e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate1("",n.forAggregate.operation.toString(),":\xa0"),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",r.templateOf(i,n.value))}}function ue(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"div",12),e.\u0275\u0275pipe(2,"beautifier"),e.\u0275\u0275text(3),e.\u0275\u0275pipe(4,"beautifier"),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275propertyInterpolate2("pTooltip","",n.forAggregate.operation.toString(),":\xa0",e.\u0275\u0275pipeBind1(2,4,n.value),""),e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate2("",n.forAggregate.operation.toString(),":\xa0",e.\u0275\u0275pipeBind2(4,6,n.value,50),"")}}function me(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275template(1,de,4,2,"ng-container",10),e.\u0275\u0275template(2,ue,5,9,"ng-container",10),e.\u0275\u0275elementContainerEnd()),2&o){const n=t.$implicit,i=e.\u0275\u0275nextContext().$implicit,r=e.\u0275\u0275nextContext(4);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",r.isTemplate(i,n.forAggregate.operation)),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",!r.isTemplate(i,n.forAggregate.operation))}}function fe(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"td"),e.\u0275\u0275template(1,me,3,2,"ng-container",9),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit,i=e.\u0275\u0275nextContext(2).$implicit,r=e.\u0275\u0275nextContext(2);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",r.retrieveGroupedByValuesFor(i[r.groupRowsBy],n.field))}}function he(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"tr",17),e.\u0275\u0275template(1,fe,2,1,"td",9),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext().columns;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",n)}}function ge(o,t){if(1&o&&e.\u0275\u0275template(0,he,2,1,"tr",16),2&o){const n=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("ngIf",n.areGroupsDefined())}}function _e(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"p-table",1),e.\u0275\u0275template(1,ne,2,1,"ng-template",2),e.\u0275\u0275template(2,le,2,1,"ng-template",3),e.\u0275\u0275template(3,pe,1,1,"ng-template",4),e.\u0275\u0275template(4,ge,1,1,"ng-template",5),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext();e.\u0275\u0275property("value",n.cleanedTableData)("columns",n.cols)("groupRowsBy",n.groupRowsBy)}}class E extends c.PluginBaseComponent{constructor(t,n,i,r,a){super(i,a,r),this.valueService=t,this.schemaMgr=n,this.loader=i,this.ref=r,this.injector=a,this.cols=new Array,this.colsMap=new Map,this.title="",this.value=null,this.targetEntityPointer=null,this.reportPointer=null,this.cleanedTableData=[],this.groupedValuesByField=new Map,null==this.schemaMgr&&(this.schemaMgr=l.dtcde.getSchemaManager())}providesTemplates(){return new c.TemplateList(null,this.fullView,this.fullView)}canProvide(t){return new c.PossibleTemplateList(!1,!0,!0)}initCommandFlow(t,n){if(super.initCommandFlow(t,n),!this.entityPointer)throw new Error("Cannot listen to changes without knowing a base position");if(this.reportPointer=this.entityPointer.parentPointer(this.schemaMgr)?.parentPointer(this.schemaMgr)??null,null!=this.reportPointer){const i=this.valueService.findTargetOfProperty("for",this.reportPointer.position);null!=i&&(this.targetEntityPointer=this.schemaMgr.generateSchemaPointer(i.pointer),this.pluginHelper.initOtherChangeListening(!0,this.targetEntityPointer.subPropertyPointer(l.DontCodeModel.APP_FIELDS_NODE)),this.decomposeJsonToMultipleChanges(this.targetEntityPointer,i.value))}this.initChangeListening(!0),this.decomposeJsonToMultipleChanges(this.entityPointer,this.provider?.getJsonAt(this.entityPointer.position))}templateOf(t,n){if(null!=t.component){t.component.setValue(n);const i=t.component.providesTemplates(t.type).forInlineView;if(i)return i}throw new Error("No component or template to display "+t.type)}setValue(t){super.setValue(t),this.cleanedTableData=null!=t.entities?t.entities:[],this.calculateGroupedValuesByField()}handleChange(t){this.targetEntityPointer?.subPropertyPointer(l.DontCodeModel.APP_FIELDS_NODE).isParentOf(t.position,!0)?this.applyUpdatesToArrayAsync(this.cols,this.colsMap,t,null,(n,i)=>this.loadSubComponent(n,i.type,i.name).then(r=>{const a=new ye(i.name,i.name,i.type);return r&&r.canProvide(i.type).forInlineView&&(a.component=r,this.applyComponentToSubField(r,i.type,i.name)),a}),this.targetEntityPointer?.subPropertyPointer(l.DontCodeModel.APP_FIELDS_NODE).position).then(n=>{this.cols=n,this.ref.markForCheck(),this.ref.detectChanges()}):null!=this.entityPointer&&"title"===t.pointer?.isSubItemOf(this.entityPointer)&&(this.title=t.type==l.ChangeType.DELETE?"":t.value)}calculateGroupedValuesByField(){if(this.groupedValuesByField.clear(),null!=this.value?.prepared?.groupedByEntities?.values){this.groupRowsBy=this.value?.prepared.groupedByEntities.groupInfo.of,null!=this.value?.prepared.groupedByEntities.groupInfo.show&&(this.groupRowsBy=this.value?.prepared.groupedByEntities.groupInfo.show.valueOf());for(const t of this.value.prepared.groupedByEntities.values.keys()){const n=this.value.prepared.groupedByEntities.values.get(t)??[];for(const i of n){let r=this.groupedValuesByField.get(t)?.get(i.forAggregate.of);if(null==r){r=new Array;let a=this.groupedValuesByField.get(t);null==a&&(a=new Map,this.groupedValuesByField.set(t,a)),a.set(i.forAggregate.of,r)}r.push(i)}}}}retrieveGroupedByValuesFor(t,n){const i=this.groupedValuesByField.get(t)?.get(n);return i??[]}isTemplate(t,n){return!(null==t.component||n==l.DontCodeGroupOperationType.Count)}areGroupsDefined(){return null!=this.groupRowsBy}}E.\u0275fac=function(t){return new(t||E)(e.\u0275\u0275directiveInject(c.ValueService),e.\u0275\u0275directiveInject(l.DontCodeSchemaManager),e.\u0275\u0275directiveInject(c.ComponentLoaderService),e.\u0275\u0275directiveInject(e.ChangeDetectorRef),e.\u0275\u0275directiveInject(e.Injector))},E.\u0275cmp=e.\u0275\u0275defineComponent({type:E,selectors:[["dontcode-report-table"]],viewQuery:function(t,n){if(1&t&&e.\u0275\u0275viewQuery(ee,7),2&t){let i;e.\u0275\u0275queryRefresh(i=e.\u0275\u0275loadQuery())&&(n.fullView=i.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:3,vars:0,consts:[["fullView",""],["rowGroupMode","subheader",3,"value","columns","groupRowsBy"],["pTemplate","header"],["pTemplate","body"],["pTemplate","groupheader"],["pTemplate","groupfooter"],[3,"id","pSortableColumn",4,"ngFor","ngForOf"],[3,"id","pSortableColumn"],[3,"field"],[4,"ngFor","ngForOf"],[4,"ngIf"],[4,"ngTemplateOutlet"],[3,"pTooltip"],["pRowGroupHeader","","class","rowgroup-header font-bold",4,"ngIf"],["pRowGroupHeader","",1,"rowgroup-header","font-bold"],[3,"colSpan"],["class","rowgroup-footer font-italic",4,"ngIf"],[1,"rowgroup-footer","font-italic"]],template:function(t,n){1&t&&(e.\u0275\u0275element(0,"dtcde-dynamic"),e.\u0275\u0275template(1,_e,5,3,"ng-template",null,0,e.\u0275\u0275templateRefExtractor))},dependencies:[g.NgForOf,g.NgIf,g.NgTemplateOutlet,q.PrimeTemplate,c.DynamicInsertPoint,x.Table,x.SortableColumn,x.RowGroupHeader,x.SortIcon,F.Tooltip,c.BeautifierPipe],styles:[".rowgroup-footer[_ngcontent-%COMP%]{background:var(--surface-100)!important}.rowgroup-header[_ngcontent-%COMP%]{background:var(--surface-200)!important}"]});class ye{constructor(t,n,i){this.field=t,this.header=n,this.type=i,this.component=null}}class T{constructor(){console.log("Report Plugin registering"),l.dtcde.registerPlugin(new z)}exposedPreviewHandlers(){return new Map([["ReportEntityComponent",P],["ReportDisplayComponent",v],["ReportTableComponent",E]])}}T.\u0275fac=function(t){return new(t||T)},T.\u0275mod=e.\u0275\u0275defineNgModule({type:T,id:"dontcode-plugin/report"}),T.\u0275inj=e.\u0275\u0275defineInjector({imports:[g.CommonModule,X.ReactiveFormsModule,Z.DropdownModule,I.ChartModule,c.PluginCommonModule.forRoot(),x.TableModule,F.TooltipModule]}),e.\u0275\u0275registerNgModuleType(T,"dontcode-plugin/report")}}]);