(self.webpackChunkreport_tester=self.webpackChunkreport_tester||[]).push([[1378],{1378:(U,_,s)=>{s.r(_),s.d(_,{ReportDisplayComponent:()=>h,ReportEntityComponent:()=>y,ReportModule:()=>c});var m=s(7863),e=s(549),p=s(7401),a=s(7138),P=s(3635);class S{constructor(t,n){this.modelMgr=t,this.data=new P.ReplaySubject(1),this.option=new P.ReplaySubject(1),this.targetType=null,this.config=n}setConfig(t){this.config=t}setTargetType(t){this.targetType=t}translatedGraphType(){if(null!=this.config?.type)return this.config.type.toLowerCase()}changeGraphType(t){if(null==this.config)throw new Error("No config to change type to "+t);this.config.type=t}dataObservable(){return this.data.asObservable()}optionObservable(){return this.option.asObservable()}updateSourceData(t){if(null==this.config)throw new Error("Cannot process source data without graph configuration");Array.isArray(t)||(t=[t]);const n="Dollar"==this.targetType||"Euro"==this.targetType||"Other currency"==this.targetType;let i=!1;if("Table"!=this.config.type){const l=[],d=[];let g=1;const H=new a.DataTransformationInfo,b="Pie"!=this.config.type;let T=null,v=this.labelFieldName;null!=this.config.by&&(v=this.config.by);for(const r of t){let u;null!=v?(r[v]instanceof Date&&(i=!0),u=this.translateDateValue(r[v])):(u=g,g++),d.push(u),b?l.push(n?{x:u,y:r[this.config.of]?.amount,src:r[this.config.of]}:{x:u,y:this.translateDateValue(this.modelMgr.extractValue(r[this.config.of],H))}):n?(l.push(r[this.config.of]?.amount),T=r[this.config.of]?.currencyCode??T):l.push(this.translateDateValue(r[this.config.of]))}const C={datasets:[{label:this.config.of,data:l}]},f={plugins:{}};if(f.plugins.title={align:"center",position:"top",display:!0,text:this.config.title},(!n||!b)&&(C.labels=d),i&&(f.scales={x:{type:"time"}}),f.plugins.autocolors="Line"!=this.config.type?{mode:"data",offset:2}:{mode:"dataset",offset:2},n&&(f.plugins.tooltip={callbacks:{label:function(r){return null!=r.raw?.src?.currencyCode?Intl.NumberFormat(void 0,{style:"currency",currency:r.raw.src.currencyCode}).format(r.parsed.y):null!=T?Intl.NumberFormat(void 0,{style:"currency",currency:T}).format(r.parsed):r.parsed.y}}}),"Bar"==this.config.type);else if("Pie"==this.config.type){const r=C;for(const u of r.datasets)u.hoverOffset=20}this.data.next(C),this.option.next(f)}}setLabelFieldName(t){this.labelFieldName=t}translateDateValue(t){return t instanceof Date?t.valueOf():t}}var E=s(2833);const x=["fullView"];function I(o,t){if(1&o&&(e.\u0275\u0275element(0,"p-chart",3),e.\u0275\u0275pipe(1,"async"),e.\u0275\u0275pipe(2,"async")),2&o){const n=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("data",e.\u0275\u0275pipeBind1(1,3,n.data$))("options",e.\u0275\u0275pipeBind1(2,5,n.option$))("type",n.type)}}function w(o,t){1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275text(1,"Please define a graph type"),e.\u0275\u0275elementContainerEnd())}function F(o,t){1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275text(1,"Tabular view here"),e.\u0275\u0275elementContainerEnd())}function M(o,t){if(1&o&&(e.\u0275\u0275template(0,I,3,7,"p-chart",1),e.\u0275\u0275template(1,w,2,0,"ng-container",2),e.\u0275\u0275template(2,F,2,0,"ng-container",2)),2&o){const n=e.\u0275\u0275nextContext();e.\u0275\u0275property("ngIf",null!==n.type&&"table"!==n.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",null===n.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","table"===n.type)}}class h extends p.AbstractDynamicComponent{constructor(t,n){super(),this.modelMgr=t,this.schemaMgr=n,this.title="",this.provider=null,this.graphModelPointer=null,this.dataTransformer=new S(t),this.data$=this.dataTransformer.dataObservable(),this.option$=this.dataTransformer.optionObservable()}providesTemplates(){return new p.TemplateList(null,this.fullView,this.fullView)}canProvide(t){return new p.PossibleTemplateList(!1,!0,!0)}setValue(t){super.setValue(t),null!=t&&null!=t.entities&&(t=t.entities),this.dataTransformer.updateSourceData(t)}initCommandFlow(t,n){this.provider=t,this.graphModelPointer=n;const i=this.provider.getJsonAt(n.position);this.dataTransformer.setConfig(i),this.type=this.dataTransformer.translatedGraphType(),this.title=i.title;const l=a.DontCodeModelPointer.parentPosition(this.graphModelPointer.containerPosition);if(null!=l){const d=this.modelMgr.findTargetOfProperty(a.DontCodeModel.APP_REPORTS_FOR_NODE,l);if(null!=d&&null!=d.value){if(this.entityNamePropertyName=this.modelMgr.guessNamePropertyOfElement(null,d.value.fields),null!=i.of)for(const g of Object.values(d.value.fields))if(g[a.DontCodeModel.APP_FIELDS_NAME_NODE]==i.of){this.dataTransformer.setTargetType(g[a.DontCodeModel.APP_FIELDS_TYPE_NODE]);break}}else this.entityNamePropertyName=null}null!=this.entityNamePropertyName&&this.dataTransformer.setLabelFieldName(this.entityNamePropertyName)}handleChange(t){t.position==this.graphModelPointer?.position?t.type===a.ChangeType.DELETE?(this.dataTransformer.setConfig(),this.type=void 0):(this.dataTransformer.setConfig(t.value),this.type=this.dataTransformer.translatedGraphType()):t.position==this.graphModelPointer?.position+"/"+a.DontCodeModel.APP_REPORTS_DISPLAY_TYPE_NODE&&(t.type===a.ChangeType.DELETE?(this.dataTransformer.setConfig(),this.type=void 0):(this.dataTransformer.changeGraphType(t.value),this.type=this.dataTransformer.translatedGraphType()))}}h.\u0275fac=function(t){return new(t||h)(e.\u0275\u0275directiveInject(a.DontCodeModelManager),e.\u0275\u0275directiveInject(a.DontCodeSchemaManager))},h.\u0275cmp=e.\u0275\u0275defineComponent({type:h,selectors:[["dontcode-report-field"]],viewQuery:function(t,n){if(1&t&&e.\u0275\u0275viewQuery(x,7),2&t){let i;e.\u0275\u0275queryRefresh(i=e.\u0275\u0275loadQuery())&&(n.fullView=i.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:2,vars:0,consts:[["fullView",""],[3,"data","options","type",4,"ngIf"],[4,"ngIf"],[3,"data","options","type"]],template:function(t,n){1&t&&e.\u0275\u0275template(0,M,3,3,"ng-template",null,0,e.\u0275\u0275templateRefExtractor)},dependencies:[m.NgIf,E.UIChart,m.AsyncPipe]});const O=["defaultdisplay"];function N(o,t){1&o&&e.\u0275\u0275elementContainer(0)}const D=function(o){return{fieldType:o}};function j(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",6),e.\u0275\u0275template(1,N,1,0,"ng-container",7),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext();e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",i.subFieldFullViewTemplate(n))("ngTemplateOutletContext",e.\u0275\u0275pureFunction1(2,D,n.type))}}function V(o,t){1&o&&e.\u0275\u0275elementContainer(0)}function A(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",8),e.\u0275\u0275template(1,V,1,0,"ng-container",7),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext();e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",i.subFieldFullViewTemplate(n))("ngTemplateOutletContext",e.\u0275\u0275pureFunction1(2,D,n.type))}}function L(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",3),e.\u0275\u0275template(1,j,2,4,"div",4),e.\u0275\u0275template(2,A,2,4,"div",5),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","Table"===n.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","Table"!==n.type)}}function Q(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",9),e.\u0275\u0275text(1),e.\u0275\u0275elementEnd()),2&o){const n=t.fieldType;e.\u0275\u0275advance(1),e.\u0275\u0275textInterpolate1(" No components for ",n," ")}}class y extends p.PluginBaseComponent{constructor(t,n,i,l,d){super(t,l,d),this.entityService=n,this.valueService=i,this.title="No Title",this.store=null,this.dataLoading=!1}initCommandFlow(t,n){if(super.initCommandFlow(t,n),!this.entityPointer)throw new Error("Cannot listen to changes without knowing a base position");const i=t.getJsonAt(this.entityPointer.position),l=this.valueService.findTargetOfProperty("for",this.entityPointer.position);null!=l&&(this.store=this.entityService.retrieveListManager(l.pointer,i)),this.decomposeJsonToMultipleChanges(this.entityPointer,i),this.initChangeListening(!0)}ngAfterViewInit(){if(super.ngAfterViewInit(),!this.entityPointer||!this.provider)throw new Error("Cannot create subcomponents before initCommandFlow is called");null!=this.store&&(this.dataLoading=!0,this.store.loadAll().then(()=>{console.debug("Loaded entities"),this.dataLoading=!1,this.updateSubFieldsValues(),this.ref.markForCheck(),this.ref.detectChanges()},t=>{this.dataLoading=!1}))}updateSubFieldsValues(){for(const t of this.fields)null!=t.component&&t.component.setValue(this.store)}providesTemplates(t){throw new Error("Method not implemented.")}canProvide(t){throw new Error("Method not implemented.")}setValue(t){console.debug("setValue() called for ReportEntity")}getValue(){console.debug("getValue() called for ReportEntity")}handleChange(t){t?.pointer?.positionInSchema===a.DontCodeModel.APP_REPORTS_DISPLAY?this.updateSubFieldsWithChange(t,a.DontCodeModel.APP_REPORTS_DISPLAY_NODE).then(n=>{null!=n&&(this.updateSubFieldsValues(),this.ref.markForCheck(),this.ref.detectChanges())}).catch(n=>{console.error(n)}):t?.pointer?.positionInSchema===a.DontCodeModel.APP_REPORTS_TITLE&&(this.title=t.type===a.ChangeType.DELETE?"":t.value)}subFieldFullViewTemplate(t){let n=super.subFieldFullViewTemplate(t);return null==n&&(n=this.defaultTemplate),n}}y.\u0275fac=function(t){return new(t||y)(e.\u0275\u0275directiveInject(p.ComponentLoaderService),e.\u0275\u0275directiveInject(p.EntityStoreService),e.\u0275\u0275directiveInject(p.ValueService),e.\u0275\u0275directiveInject(e.Injector),e.\u0275\u0275directiveInject(e.ChangeDetectorRef))},y.\u0275cmp=e.\u0275\u0275defineComponent({type:y,selectors:[["dontcode-report-entity"]],viewQuery:function(t,n){if(1&t&&e.\u0275\u0275viewQuery(O,5),2&t){let i;e.\u0275\u0275queryRefresh(i=e.\u0275\u0275loadQuery())&&(n.defaultTemplate=i.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:7,vars:2,consts:[[1,"p-fluid"],["class","field grid",4,"ngFor","ngForOf"],["defaultdisplay",""],[1,"field","grid"],["class","col-12",4,"ngIf"],["class","col-12 md:col-6",4,"ngIf"],[1,"col-12"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"col-12","md:col-6"],[1,"col-12","md:col-10"]],template:function(t,n){1&t&&(e.\u0275\u0275element(0,"dtcde-dynamic"),e.\u0275\u0275elementStart(1,"h1"),e.\u0275\u0275text(2),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementStart(3,"div",0),e.\u0275\u0275template(4,L,3,2,"div",1),e.\u0275\u0275elementEnd(),e.\u0275\u0275template(5,Q,2,1,"ng-template",null,2,e.\u0275\u0275templateRefExtractor)),2&t&&(e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate1("Report ",n.title,""),e.\u0275\u0275advance(2),e.\u0275\u0275property("ngForOf",n.getSubFields()))},dependencies:[m.NgForOf,m.NgIf,m.NgTemplateOutlet,p.DynamicInsertPoint]});var R=s(2710),G=s(5585),$=s.n(G),Y=s(6145);class B{constructor(){R.Chart.register($()),R._adapters._date.override(Y.StdDateAdapter.chartJsStandardAdapter())}getConfiguration(){return{plugin:{id:"ReportPlugin","display-name":"Implements the Dont-code standard report model.",version:"1.0.0"},"preview-handlers":[{location:{parent:a.DontCodeModel.APP_REPORTS,id:""},class:{name:"ReportEntityComponent",source:"report"}},{location:{parent:a.DontCodeModel.APP_REPORTS_DISPLAY,id:""},class:{name:"ReportDisplayComponent",source:"report"}}]}}pluginInit(t){}}var J=s(7022),k=s(6674);class c{constructor(){console.log("Report Plugin registering"),a.dtcde.registerPlugin(new B)}exposedPreviewHandlers(){return new Map([["ReportEntityComponent",y],["ReportDisplayComponent",h]])}}c.\u0275fac=function(t){return new(t||c)},c.\u0275mod=e.\u0275\u0275defineNgModule({type:c,id:"dontcode-plugin/report"}),c.\u0275inj=e.\u0275\u0275defineInjector({imports:[m.CommonModule,J.ReactiveFormsModule,k.DropdownModule,E.ChartModule,p.PluginCommonModule.forRoot()]}),e.\u0275\u0275registerNgModuleType(c,"dontcode-plugin/report")}}]);