(self.webpackChunkreport_tester=self.webpackChunkreport_tester||[]).push([[2107],{62107:(Ce,x,c)=>{c.r(x),c.d(x,{ReportDisplayComponent:()=>w,ReportEntityComponent:()=>S,ReportModule:()=>F,ReportTableComponent:()=>O});var g=c(61395),e=c(41855),d=c(8584),l=c(39732),D=c(56241);class V{constructor(r,t){this.modelMgr=r,this.data=new D.ReplaySubject(1),this.option=new D.ReplaySubject(1),this.targetType=null,this.config=t}setConfig(r){this.config=r}setTargetType(r){this.targetType=r}translatedGraphType(){if(null!=this.config?.type)return this.config.type.toLowerCase()}changeGraphType(r){if(null==this.config)throw new Error("No config to change type to "+r);this.config.type=r}dataObservable(){return this.data.asObservable()}optionObservable(){return this.option.asObservable()}updateSourceData(r){if(null==this.config)throw new Error("Cannot process source data without graph configuration");const t="Dollar"==this.targetType||"Euro"==this.targetType||"Other currency"==this.targetType;let o=!1;if("Table"!=this.config.type){const i=[],a=[];let s=1;const _=new l.DataTransformationInfo,m="Pie"!=this.config.type;let y=this.labelFieldName;null!=this.config.by&&(y=this.config.by);for(const u of r.entities){let C;null!=y?(u[y]instanceof Date&&(o=!0),C=this.translateDateValue(u[y])):(C=s,s++);const h=this.translateDateValue(this.modelMgr.extractValue(u[this.config.of],_));let p=a.indexOf(C);-1==p&&a.push(C),m?-1==p?i.push({x:C,y:h,src:u[this.config.of]}):"number"==typeof i[p].y?(i[p].y=null!=h?i[p].y+h:i[p].y,i[p].src=this.modelMgr.modifyValues(i[p].src,u[this.config.of],_,(P,E)=>null==P?E:null==E?P:P+E)):null==i[p].y?(i[p].y=h,i[p].src=u[this.config.of]):i.push({x:C,y:h,src:u[this.config.of]}):-1==p?i.push(h):"number"==typeof i[p]?i[p]=null!=h?i[p]+h:i[p]:null==i[p]?i[p]=h:(p=-1,a.push(C),i.push(h))}const T={datasets:[{label:this.config.of,data:i}]},f={plugins:{}};if(f.plugins.title={align:"center",position:"top",display:!0,text:this.config.title},(!t||!m)&&(T.labels=a),o&&(f.scales={x:{type:"time"}}),f.plugins.autocolors="Line"!=this.config.type?{mode:"data",offset:2}:{mode:"dataset",offset:2},t&&(f.plugins.tooltip={callbacks:{label:function(u){return null!=u.raw?.src?.currencyCode?Intl.NumberFormat(void 0,{style:"currency",currency:u.raw.src.currencyCode}).format(u.parsed.y):u.parsed.y}}}),"Bar"==this.config.type);else if("Pie"==this.config.type){const u=T;for(const C of u.datasets)C.hoverOffset=20}this.data.next(T),this.option.next(f)}}setLabelFieldName(r){this.labelFieldName=r}translateDateValue(r){return r instanceof Date?r.valueOf():r}}var b=c(9776);const A=["fullView"];function j(n,r){if(1&n&&(e.\u0275\u0275element(0,"p-chart",3),e.\u0275\u0275pipe(1,"async"),e.\u0275\u0275pipe(2,"async")),2&n){const t=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("data",e.\u0275\u0275pipeBind1(1,3,t.chartData$))("options",e.\u0275\u0275pipeBind1(2,5,t.chartOption$))("type",t.type)}}function B(n,r){1&n&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275text(1,"Please define a graph type"),e.\u0275\u0275elementContainerEnd())}function L(n,r){if(1&n&&(e.\u0275\u0275template(0,j,3,7,"p-chart",1),e.\u0275\u0275template(1,B,2,0,"ng-container",2)),2&n){const t=e.\u0275\u0275nextContext();e.\u0275\u0275property("ngIf",void 0!==t.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",void 0===t.type)}}let w=(()=>{class n extends d.AbstractDynamicComponent{constructor(t,o){super(),this.modelMgr=t,this.schemaMgr=o,this.title="",this.provider=null,this.graphModelPointer=null,this.dataTransformer=new V(t),this.chartData$=this.dataTransformer.dataObservable(),this.chartOption$=this.dataTransformer.optionObservable()}providesTemplates(){return new d.TemplateList(null,this.fullView,this.fullView)}canProvide(t){return new d.PossibleTemplateList(!1,!0,!0)}setValue(t){super.setValue(t),this.dataTransformer.updateSourceData(t)}initCommandFlow(t,o){this.provider=t,this.graphModelPointer=o;const i=this.provider.getJsonAt(o.position);this.dataTransformer.setConfig(i),this.type=this.dataTransformer.translatedGraphType(),this.title=i.title;const a=l.DontCodeModelPointer.parentPosition(this.graphModelPointer.containerPosition);if(null!=a){const s=this.modelMgr.findTargetOfProperty(l.DontCodeModel.APP_REPORTS_FOR_NODE,a);if(null!=s&&null!=s.value){if(this.entityNamePropertyName=this.modelMgr.guessNamePropertyOfElement(null,s.value.fields),null!=i.of)for(const _ of Object.values(s.value.fields))if(_[l.DontCodeModel.APP_FIELDS_NAME_NODE]==i.of){this.dataTransformer.setTargetType(_[l.DontCodeModel.APP_FIELDS_TYPE_NODE]);break}}else this.entityNamePropertyName=null}null!=this.entityNamePropertyName&&this.dataTransformer.setLabelFieldName(this.entityNamePropertyName)}handleChange(t){t.position==this.graphModelPointer?.position?t.type===l.ChangeType.DELETE?(this.dataTransformer.setConfig(),this.type=void 0):(this.dataTransformer.setConfig(t.value),this.type=this.dataTransformer.translatedGraphType()):t.position==this.graphModelPointer?.position+"/"+l.DontCodeModel.APP_REPORTS_DISPLAY_TYPE_NODE&&(t.type===l.ChangeType.DELETE?(this.dataTransformer.setConfig(),this.type=void 0):(this.dataTransformer.changeGraphType(t.value),this.type=this.dataTransformer.translatedGraphType()))}static#e=this.\u0275fac=function(o){return new(o||n)(e.\u0275\u0275directiveInject(l.DontCodeModelManager),e.\u0275\u0275directiveInject(l.DontCodeSchemaManager))};static#t=this.\u0275cmp=e.\u0275\u0275defineComponent({type:n,selectors:[["dontcode-report-field"]],viewQuery:function(o,i){if(1&o&&e.\u0275\u0275viewQuery(A,7),2&o){let a;e.\u0275\u0275queryRefresh(a=e.\u0275\u0275loadQuery())&&(i.fullView=a.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:2,vars:0,consts:[["fullView",""],[3,"data","options","type",4,"ngIf"],[4,"ngIf"],[3,"data","options","type"]],template:function(o,i){1&o&&e.\u0275\u0275template(0,L,2,2,"ng-template",null,0,e.\u0275\u0275templateRefExtractor)},dependencies:[g.NgIf,b.UIChart,g.AsyncPipe]})}return n})();class N{constructor(r,t,o,i){this.modelMgr=r,this.affectedColumns=t,this.groupType=o,this.entityPosition=i}postLoadingTransformation(r){if(null==this.groupType.show)return r;const t=new Array,o=this.calculateFieldMapping(),i=new Map;for(const a of r){const s=structuredClone(a);s[this.groupType.show.valueOf()]=this.calculateRelevantColumn(a,o,i),t.push(s)}return t}calculateRelevantColumn(r,t,o){let i,a,s;const _=this.entityPosition.subItemPointer(l.DontCodeModel.APP_FIELDS_NODE);for(const m of this.affectedColumns){let y=o.get(m);null==y&&(y=new l.DataTransformationInfo,o.set(m,y));const T=t.get(m);if(null==T)return;const f=this.modelMgr.extractValue(r[m],y,_.subItemPointer(T));null==i||null==a?(i=r[m],a=f,s=m):this.groupType.show==l.DontCodeReportGroupShowType.OnlyLowest?f<a&&(i=r[m],a=f,s=m):f>a&&(i=r[m],a=f,s=m)}return s}calculateFieldMapping(){const r=this.modelMgr.findAtPosition(this.entityPosition.position,!1),t=new Map;if(null!=r.fields)for(const o of Object.entries(r.fields))null!=o[1].name&&t.set(o[1].name,o[0]);return t}}const $=["defaultdisplay"];function G(n,r){1&n&&e.\u0275\u0275elementContainer(0)}const R=function(n){return{fieldType:n}};function Q(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"div",6),e.\u0275\u0275template(1,G,1,0,"ng-container",7),e.\u0275\u0275elementEnd()),2&n){const t=e.\u0275\u0275nextContext().$implicit,o=e.\u0275\u0275nextContext();e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",o.subFieldFullViewTemplate(t))("ngTemplateOutletContext",e.\u0275\u0275pureFunction1(2,R,t.type))}}function J(n,r){1&n&&e.\u0275\u0275elementContainer(0)}function Y(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"div",8),e.\u0275\u0275template(1,J,1,0,"ng-container",7),e.\u0275\u0275elementEnd()),2&n){const t=e.\u0275\u0275nextContext().$implicit,o=e.\u0275\u0275nextContext();e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",o.subFieldFullViewTemplate(t))("ngTemplateOutletContext",e.\u0275\u0275pureFunction1(2,R,t.type))}}function k(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"div",3),e.\u0275\u0275template(1,Q,2,4,"div",4),e.\u0275\u0275template(2,Y,2,4,"div",5),e.\u0275\u0275elementEnd()),2&n){const t=r.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","Table"===t.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","Table"!==t.type)}}function H(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"div",9),e.\u0275\u0275text(1),e.\u0275\u0275elementEnd()),2&n){const t=r.fieldType;e.\u0275\u0275advance(1),e.\u0275\u0275textInterpolate1(" No components for ",t," ")}}let S=(()=>{class n extends d.PluginBaseComponent{constructor(t,o,i,a,s,_){super(t,a,s),this.entityService=o,this.valueService=i,this.modelMgr=_,this.title="No Title",this.store=null,this.dataLoading=!1,this.reportDescription=null,this.reportEntityData=new l.DontCodeStorePreparedEntities([]),this.targetEntityPointer=null,this.fieldTypeTransformer=null,null==this.modelMgr&&(this.modelMgr=l.dtcde.getModelManager())}initCommandFlow(t,o){if(super.initCommandFlow(t,o),!this.entityPointer)throw new Error("Cannot listen to changes without knowing a base position");this.reportDescription=t.getJsonAt(this.entityPointer.position),this.initTargetEntity(),this.decomposeJsonToMultipleChanges(this.entityPointer,this.reportDescription),this.initChangeListening(!0)}initTargetEntity(){if(null==this.entityPointer)return;const t=this.valueService.findTargetOfProperty("for",this.entityPointer.position);null!=t&&null!=this.provider&&(this.targetEntityPointer=this.provider.getSchemaManager().generateSchemaPointer(t.pointer),this.store=this.entityService.retrieveListManager(this.targetEntityPointer,this.valueService.findAtPosition(t.pointer,!1)),this.pluginHelper.initOtherChangeListening(!0,this.targetEntityPointer))}ngAfterViewInit(){super.ngAfterViewInit(),this.loadTargetEntities()}loadTargetEntities(){if(!this.entityPointer||!this.provider)throw new Error("Cannot create subcomponents before initCommandFlow is called");null!=this.store&&(this.dataLoading=!0,this.calculateTransformer(),this.store.searchAndPrepareEntities(this.reportDescription?.sortedBy,this.reportDescription?.groupedBy,this.fieldTypeTransformer??void 0).then(()=>{console.debug("Loaded entities"),this.reportEntityData=this.store?.prepared??new l.DontCodeStorePreparedEntities([]),this.dataLoading=!1,this.updateSubFieldsValues(),this.ref.markForCheck(),this.ref.detectChanges()},t=>{this.dataLoading=!1}))}updateSubFieldsValues(){for(const t of this.fields)null!=t.component&&t.component.setValue(this.store)}providesTemplates(t){throw new Error("Method not implemented.")}canProvide(t){throw new Error("Method not implemented.")}setValue(t){console.debug("setValue() called for ReportEntity")}getValue(){console.debug("getValue() called for ReportEntity")}handleChange(t){t?.pointer?.positionInSchema===l.DontCodeModel.APP_REPORTS_DISPLAY?this.updateSubFieldsWithChange(t,l.DontCodeModel.APP_REPORTS_DISPLAY_NODE).then(o=>{null!=o&&(this.updateSubFieldsValues(),this.ref.markForCheck(),this.ref.detectChanges())}).catch(o=>{console.error(o)}):t?.pointer?.positionInSchema===l.DontCodeModel.APP_REPORTS_TITLE?this.title=t.type===l.ChangeType.DELETE?"":t.value:null!=this.targetEntityPointer&&null!=t?.pointer?.isSubItemOf(this.targetEntityPointer)&&this.loadTargetEntities()}subFieldFullViewTemplate(t){let o=super.subFieldFullViewTemplate(t);return null==o&&(o=this.defaultTemplate),o}calculateTransformer(){if(this.fieldTypeTransformer=null,null!=this.reportDescription&&null!=this.targetEntityPointer&&null!=this.provider&&null!=this.reportDescription.groupedBy){const t=Object.values(this.reportDescription.groupedBy)[0]?.of;if(null!=t){const o=this.valueService.findAtPosition(this.targetEntityPointer.position,!1);if(null!=o.fields){const i=new Array;for(const a of Object.values(o.fields)){if(a.name==t)return;a.type==t&&i.push(a.name)}0!=i.length&&(this.fieldTypeTransformer=new N(this.modelMgr,i,Object.values(this.reportDescription.groupedBy)[0],this.targetEntityPointer))}}}}static#e=this.\u0275fac=function(o){return new(o||n)(e.\u0275\u0275directiveInject(d.ComponentLoaderService),e.\u0275\u0275directiveInject(d.EntityStoreService),e.\u0275\u0275directiveInject(d.ValueService),e.\u0275\u0275directiveInject(e.Injector),e.\u0275\u0275directiveInject(e.ChangeDetectorRef),e.\u0275\u0275directiveInject(l.DontCodeModelManager,8))};static#t=this.\u0275cmp=e.\u0275\u0275defineComponent({type:n,selectors:[["dontcode-report-entity"]],viewQuery:function(o,i){if(1&o&&e.\u0275\u0275viewQuery($,5),2&o){let a;e.\u0275\u0275queryRefresh(a=e.\u0275\u0275loadQuery())&&(i.defaultTemplate=a.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:7,vars:2,consts:[[1,"p-fluid"],["class","field grid",4,"ngFor","ngForOf"],["defaultdisplay",""],[1,"field","grid"],["class","col-12",4,"ngIf"],["class","col-12 md:col-6",4,"ngIf"],[1,"col-12"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"col-12","md:col-6"],[1,"col-12","md:col-10"]],template:function(o,i){1&o&&(e.\u0275\u0275element(0,"dtcde-dynamic"),e.\u0275\u0275elementStart(1,"h1"),e.\u0275\u0275text(2),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementStart(3,"div",0),e.\u0275\u0275template(4,k,3,2,"div",1),e.\u0275\u0275elementEnd(),e.\u0275\u0275template(5,H,2,1,"ng-template",null,2,e.\u0275\u0275templateRefExtractor)),2&o&&(e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate1("Report ",i.title,""),e.\u0275\u0275advance(2),e.\u0275\u0275property("ngForOf",i.getSubFields()))},dependencies:[g.NgForOf,g.NgIf,g.NgTemplateOutlet,d.DynamicInsertPoint]})}return n})();var I=c(36812),U=c(7170),K=c(41857),W=c.n(K);class z{constructor(){I.Chart.register(W()),I._adapters._date.override(U.StdDateAdapter.chartJsStandardAdapter())}getConfiguration(){return{plugin:{id:"ReportPlugin","display-name":"Implements the Dont-code standard report model.",version:"1.0.0"},"preview-handlers":[{location:{parent:l.DontCodeModel.APP_REPORTS,id:""},class:{name:"ReportEntityComponent",source:"report"}},{location:{parent:l.DontCodeModel.APP_REPORTS_DISPLAY,id:"type",values:["Table"]},class:{name:"ReportTableComponent",source:"report"}},{location:{parent:l.DontCodeModel.APP_REPORTS_DISPLAY},class:{name:"ReportDisplayComponent",source:"report"}}]}}pluginInit(r){}}var X=c(77527),Z=c(78905),v=c(77020),q=c(51295),M=c(77744);const ee=["fullView"];function te(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"th",7),e.\u0275\u0275text(1),e.\u0275\u0275element(2,"p-sortIcon",8),e.\u0275\u0275elementEnd()),2&n){const t=r.$implicit;e.\u0275\u0275propertyInterpolate1("id","header-",t.header,""),e.\u0275\u0275property("pSortableColumn",t.field),e.\u0275\u0275advance(1),e.\u0275\u0275textInterpolate1(" ",t.header," "),e.\u0275\u0275advance(1),e.\u0275\u0275property("field",t.field)}}function ne(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"tr"),e.\u0275\u0275template(1,te,3,4,"th",6),e.\u0275\u0275elementEnd()),2&n){const t=r.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",t)}}function oe(n,r){1&n&&e.\u0275\u0275elementContainer(0)}function ie(n,r){if(1&n&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275template(1,oe,1,0,"ng-container",11),e.\u0275\u0275elementContainerEnd()),2&n){const t=e.\u0275\u0275nextContext().$implicit,o=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext(2);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",i.templateOf(t,o[t.field]))}}function re(n,r){if(1&n&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"span",12),e.\u0275\u0275pipe(2,"beautifier"),e.\u0275\u0275text(3),e.\u0275\u0275pipe(4,"beautifier"),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&n){const t=e.\u0275\u0275nextContext().$implicit,o=e.\u0275\u0275nextContext().$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275propertyInterpolate("pTooltip",e.\u0275\u0275pipeBind1(2,2,o[t.field])),e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate(e.\u0275\u0275pipeBind2(4,4,o[t.field],50))}}function ae(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"td"),e.\u0275\u0275template(1,ie,2,1,"ng-container",10),e.\u0275\u0275template(2,re,5,7,"ng-container",10),e.\u0275\u0275elementEnd()),2&n){const t=r.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",t.component),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",!t.component)}}function le(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"tr"),e.\u0275\u0275template(1,ae,3,2,"td",9),e.\u0275\u0275elementEnd()),2&n){const t=r.columns;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",t)}}function se(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"tr",14)(1,"td",15)(2,"span"),e.\u0275\u0275text(3),e.\u0275\u0275elementEnd()()()),2&n){const t=e.\u0275\u0275nextContext(),o=t.columns,i=t.$implicit,a=e.\u0275\u0275nextContext(2);e.\u0275\u0275advance(1),e.\u0275\u0275property("colSpan",o.length),e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate(i[a.groupRowsBy])}}function pe(n,r){if(1&n&&e.\u0275\u0275template(0,se,4,2,"tr",13),2&n){const t=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("ngIf",t.areGroupsDefined())}}function ce(n,r){1&n&&e.\u0275\u0275elementContainer(0)}function de(n,r){if(1&n&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"div"),e.\u0275\u0275text(2),e.\u0275\u0275template(3,ce,1,0,"ng-container",11),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&n){const t=e.\u0275\u0275nextContext().$implicit,o=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext(4);e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate1("",t.forAggregate.operation.toString(),":\xa0"),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",i.templateOf(o,t.value))}}function ue(n,r){if(1&n&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"div",12),e.\u0275\u0275pipe(2,"beautifier"),e.\u0275\u0275text(3),e.\u0275\u0275pipe(4,"beautifier"),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&n){const t=e.\u0275\u0275nextContext().$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275propertyInterpolate2("pTooltip","",t.forAggregate.operation.toString(),":\xa0",e.\u0275\u0275pipeBind1(2,4,t.value),""),e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate2("",t.forAggregate.operation.toString(),":\xa0",e.\u0275\u0275pipeBind2(4,6,t.value,50),"")}}function me(n,r){if(1&n&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275template(1,de,4,2,"ng-container",10),e.\u0275\u0275template(2,ue,5,9,"ng-container",10),e.\u0275\u0275elementContainerEnd()),2&n){const t=r.$implicit,o=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext(4);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",i.isTemplate(o,t.forAggregate.operation)),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",!i.isTemplate(o,t.forAggregate.operation))}}function fe(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"td"),e.\u0275\u0275template(1,me,3,2,"ng-container",9),e.\u0275\u0275elementEnd()),2&n){const t=r.$implicit,o=e.\u0275\u0275nextContext(2).$implicit,i=e.\u0275\u0275nextContext(2);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",i.retrieveGroupedByValuesFor(o[i.groupRowsBy],t.field))}}function he(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"tr",17),e.\u0275\u0275template(1,fe,2,1,"td",9),e.\u0275\u0275elementEnd()),2&n){const t=e.\u0275\u0275nextContext().columns;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",t)}}function ge(n,r){if(1&n&&e.\u0275\u0275template(0,he,2,1,"tr",16),2&n){const t=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("ngIf",t.areGroupsDefined())}}function _e(n,r){if(1&n&&(e.\u0275\u0275elementStart(0,"p-table",1),e.\u0275\u0275template(1,ne,2,1,"ng-template",2),e.\u0275\u0275template(2,le,2,1,"ng-template",3),e.\u0275\u0275template(3,pe,1,1,"ng-template",4),e.\u0275\u0275template(4,ge,1,1,"ng-template",5),e.\u0275\u0275elementEnd()),2&n){const t=e.\u0275\u0275nextContext();e.\u0275\u0275property("value",t.cleanedTableData)("columns",t.cols)("groupRowsBy",t.groupRowsBy)}}let O=(()=>{class n extends d.PluginBaseComponent{constructor(t,o,i,a,s){super(i,s,a),this.valueService=t,this.schemaMgr=o,this.loader=i,this.ref=a,this.injector=s,this.cols=new Array,this.colsMap=new Map,this.title="",this.value=null,this.targetEntityPointer=null,this.reportPointer=null,this.cleanedTableData=[],this.groupedValuesByField=new Map,null==this.schemaMgr&&(this.schemaMgr=l.dtcde.getSchemaManager())}providesTemplates(){return new d.TemplateList(null,this.fullView,this.fullView)}canProvide(t){return new d.PossibleTemplateList(!1,!0,!0)}initCommandFlow(t,o){if(super.initCommandFlow(t,o),!this.entityPointer)throw new Error("Cannot listen to changes without knowing a base position");if(this.reportPointer=this.entityPointer.parentPointer(this.schemaMgr)?.parentPointer(this.schemaMgr)??null,null!=this.reportPointer){const i=this.valueService.findTargetOfProperty("for",this.reportPointer.position);null!=i&&(this.targetEntityPointer=this.schemaMgr.generateSchemaPointer(i.pointer),this.pluginHelper.initOtherChangeListening(!0,this.targetEntityPointer.subPropertyPointer(l.DontCodeModel.APP_FIELDS_NODE)),this.decomposeJsonToMultipleChanges(this.targetEntityPointer,i.value))}this.initChangeListening(!0),this.decomposeJsonToMultipleChanges(this.entityPointer,this.provider?.getJsonAt(this.entityPointer.position))}templateOf(t,o){if(null!=t.component){t.component.setValue(o);const i=t.component.providesTemplates(t.type).forInlineView;if(i)return i}throw new Error("No component or template to display "+t.type)}setValue(t){super.setValue(t),this.cleanedTableData=null!=t.entities?t.entities:[],this.calculateGroupedValuesByField()}handleChange(t){this.targetEntityPointer?.subPropertyPointer(l.DontCodeModel.APP_FIELDS_NODE).isParentOf(t.position,!0)?this.applyUpdatesToArrayAsync(this.cols,this.colsMap,t,null,(o,i)=>this.loadSubComponent(o,i.type,i.name).then(a=>{const s=new ye(i.name,i.name,i.type);return a&&a.canProvide(i.type).forInlineView&&(s.component=a,this.applyComponentToSubField(a,i.type,i.name)),s}),this.targetEntityPointer?.subPropertyPointer(l.DontCodeModel.APP_FIELDS_NODE).position).then(o=>{this.cols=o,this.ref.markForCheck(),this.ref.detectChanges()}):null!=this.entityPointer&&"title"===t.pointer?.isSubItemOf(this.entityPointer)&&(this.title=t.type==l.ChangeType.DELETE?"":t.value)}calculateGroupedValuesByField(){if(this.groupedValuesByField.clear(),null!=this.value?.prepared?.groupedByEntities?.values){this.groupRowsBy=this.value?.prepared.groupedByEntities.groupInfo.of,null!=this.value?.prepared.groupedByEntities.groupInfo.show&&(this.groupRowsBy=this.value?.prepared.groupedByEntities.groupInfo.show.valueOf());for(const t of this.value.prepared.groupedByEntities.values.keys()){const o=this.value.prepared.groupedByEntities.values.get(t)??[];for(const i of o){let a=this.groupedValuesByField.get(t)?.get(i.forAggregate.of);if(null==a){a=new Array;let s=this.groupedValuesByField.get(t);null==s&&(s=new Map,this.groupedValuesByField.set(t,s)),s.set(i.forAggregate.of,a)}a.push(i)}}}}retrieveGroupedByValuesFor(t,o){const i=this.groupedValuesByField.get(t)?.get(o);return i??[]}isTemplate(t,o){return!(null==t.component||o==l.DontCodeGroupOperationType.Count)}areGroupsDefined(){return null!=this.groupRowsBy}static#e=this.\u0275fac=function(o){return new(o||n)(e.\u0275\u0275directiveInject(d.ValueService),e.\u0275\u0275directiveInject(l.DontCodeSchemaManager),e.\u0275\u0275directiveInject(d.ComponentLoaderService),e.\u0275\u0275directiveInject(e.ChangeDetectorRef),e.\u0275\u0275directiveInject(e.Injector))};static#t=this.\u0275cmp=e.\u0275\u0275defineComponent({type:n,selectors:[["dontcode-report-table"]],viewQuery:function(o,i){if(1&o&&e.\u0275\u0275viewQuery(ee,7),2&o){let a;e.\u0275\u0275queryRefresh(a=e.\u0275\u0275loadQuery())&&(i.fullView=a.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:3,vars:0,consts:[["fullView",""],["rowGroupMode","subheader",3,"value","columns","groupRowsBy"],["pTemplate","header"],["pTemplate","body"],["pTemplate","groupheader"],["pTemplate","groupfooter"],[3,"id","pSortableColumn",4,"ngFor","ngForOf"],[3,"id","pSortableColumn"],[3,"field"],[4,"ngFor","ngForOf"],[4,"ngIf"],[4,"ngTemplateOutlet"],[3,"pTooltip"],["pRowGroupHeader","","class","rowgroup-header font-bold",4,"ngIf"],["pRowGroupHeader","",1,"rowgroup-header","font-bold"],[3,"colSpan"],["class","rowgroup-footer font-italic",4,"ngIf"],[1,"rowgroup-footer","font-italic"]],template:function(o,i){1&o&&(e.\u0275\u0275element(0,"dtcde-dynamic"),e.\u0275\u0275template(1,_e,5,3,"ng-template",null,0,e.\u0275\u0275templateRefExtractor))},dependencies:[g.NgForOf,g.NgIf,g.NgTemplateOutlet,q.PrimeTemplate,d.DynamicInsertPoint,v.Table,v.SortableColumn,v.RowGroupHeader,v.SortIcon,M.Tooltip,d.BeautifierPipe],styles:[".rowgroup-footer[_ngcontent-%COMP%]{background:var(--surface-100)!important}.rowgroup-header[_ngcontent-%COMP%]{background:var(--surface-200)!important}"]})}return n})();class ye{constructor(r,t,o){this.field=r,this.header=t,this.type=o,this.component=null}}let F=(()=>{class n{constructor(){console.log("Report Plugin registering"),l.dtcde.registerPlugin(new z)}exposedPreviewHandlers(){return new Map([["ReportEntityComponent",S],["ReportDisplayComponent",w],["ReportTableComponent",O]])}static#e=this.\u0275fac=function(o){return new(o||n)};static#t=this.\u0275mod=e.\u0275\u0275defineNgModule({type:n,id:"dontcode-plugin/report"});static#n=this.\u0275inj=e.\u0275\u0275defineInjector({imports:[g.CommonModule,X.ReactiveFormsModule,Z.DropdownModule,b.ChartModule,d.PluginCommonModule.forRoot(),v.TableModule,M.TooltipModule]})}return n})();e.\u0275\u0275registerNgModuleType(F,"dontcode-plugin/report")}}]);