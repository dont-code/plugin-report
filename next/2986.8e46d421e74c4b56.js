(self.webpackChunkreport_tester=self.webpackChunkreport_tester||[]).push([[2986],{12986:(fe,b,p)=>{p.r(b),p.d(b,{ReportDisplayComponent:()=>T,ReportEntityComponent:()=>v,ReportModule:()=>g,ReportTableComponent:()=>P});var f=p(57863),e=p(30549),c=p(17401),a=p(67138),x=p(92256);class M{constructor(t,n){this.modelMgr=t,this.data=new x.ReplaySubject(1),this.option=new x.ReplaySubject(1),this.targetType=null,this.config=n}setConfig(t){this.config=t}setTargetType(t){this.targetType=t}translatedGraphType(){if(null!=this.config?.type)return this.config.type.toLowerCase()}changeGraphType(t){if(null==this.config)throw new Error("No config to change type to "+t);this.config.type=t}dataObservable(){return this.data.asObservable()}optionObservable(){return this.option.asObservable()}updateSourceData(t){if(null==this.config)throw new Error("Cannot process source data without graph configuration");const n="Dollar"==this.targetType||"Euro"==this.targetType||"Other currency"==this.targetType;let i=!1;if("Table"!=this.config.type){const r=[],l=[];let m=1;const D=new a.DataTransformationInfo,d="Pie"!=this.config.type;let h=null,y=this.labelFieldName;null!=this.config.by&&(y=this.config.by);for(const s of t.entities){let C;null!=y?(s[y]instanceof Date&&(i=!0),C=this.translateDateValue(s[y])):(C=m,m++),l.push(C),d?r.push(n?{x:C,y:s[this.config.of]?.amount,src:s[this.config.of]}:{x:C,y:this.translateDateValue(this.modelMgr.extractValue(s[this.config.of],D))}):n?(r.push(s[this.config.of]?.amount),h=s[this.config.of]?.currencyCode??h):r.push(this.translateDateValue(s[this.config.of]))}const u={datasets:[{label:this.config.of,data:r}]},_={plugins:{}};if(_.plugins.title={align:"center",position:"top",display:!0,text:this.config.title},(!n||!d)&&(u.labels=l),i&&(_.scales={x:{type:"time"}}),_.plugins.autocolors="Line"!=this.config.type?{mode:"data",offset:2}:{mode:"dataset",offset:2},n&&(_.plugins.tooltip={callbacks:{label:function(s){return null!=s.raw?.src?.currencyCode?Intl.NumberFormat(void 0,{style:"currency",currency:s.raw.src.currencyCode}).format(s.parsed.y):null!=h?Intl.NumberFormat(void 0,{style:"currency",currency:h}).format(s.parsed):s.parsed.y}}}),"Bar"==this.config.type);else if("Pie"==this.config.type){const s=u;for(const C of s.datasets)C.hoverOffset=20}this.data.next(u),this.option.next(_)}}setLabelFieldName(t){this.labelFieldName=t}translateDateValue(t){return t instanceof Date?t.valueOf():t}}var w=p(62833);const F=["fullView"];function O(o,t){if(1&o&&(e.\u0275\u0275element(0,"p-chart",3),e.\u0275\u0275pipe(1,"async"),e.\u0275\u0275pipe(2,"async")),2&o){const n=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("data",e.\u0275\u0275pipeBind1(1,3,n.chartData$))("options",e.\u0275\u0275pipeBind1(2,5,n.chartOption$))("type",n.type)}}function V(o,t){1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275text(1,"Please define a graph type"),e.\u0275\u0275elementContainerEnd())}function A(o,t){if(1&o&&(e.\u0275\u0275template(0,O,3,7,"p-chart",1),e.\u0275\u0275template(1,V,2,0,"ng-container",2)),2&o){const n=e.\u0275\u0275nextContext();e.\u0275\u0275property("ngIf",void 0!==n.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",void 0===n.type)}}class T extends c.AbstractDynamicComponent{constructor(t,n){super(),this.modelMgr=t,this.schemaMgr=n,this.title="",this.provider=null,this.graphModelPointer=null,this.dataTransformer=new M(t),this.chartData$=this.dataTransformer.dataObservable(),this.chartOption$=this.dataTransformer.optionObservable()}providesTemplates(){return new c.TemplateList(null,this.fullView,this.fullView)}canProvide(t){return new c.PossibleTemplateList(!1,!0,!0)}setValue(t){super.setValue(t),this.dataTransformer.updateSourceData(t)}initCommandFlow(t,n){this.provider=t,this.graphModelPointer=n;const i=this.provider.getJsonAt(n.position);this.dataTransformer.setConfig(i),this.type=this.dataTransformer.translatedGraphType(),this.title=i.title;const r=a.DontCodeModelPointer.parentPosition(this.graphModelPointer.containerPosition);if(null!=r){const l=this.modelMgr.findTargetOfProperty(a.DontCodeModel.APP_REPORTS_FOR_NODE,r);if(null!=l&&null!=l.value){if(this.entityNamePropertyName=this.modelMgr.guessNamePropertyOfElement(null,l.value.fields),null!=i.of)for(const m of Object.values(l.value.fields))if(m[a.DontCodeModel.APP_FIELDS_NAME_NODE]==i.of){this.dataTransformer.setTargetType(m[a.DontCodeModel.APP_FIELDS_TYPE_NODE]);break}}else this.entityNamePropertyName=null}null!=this.entityNamePropertyName&&this.dataTransformer.setLabelFieldName(this.entityNamePropertyName)}handleChange(t){t.position==this.graphModelPointer?.position?t.type===a.ChangeType.DELETE?(this.dataTransformer.setConfig(),this.type=void 0):(this.dataTransformer.setConfig(t.value),this.type=this.dataTransformer.translatedGraphType()):t.position==this.graphModelPointer?.position+"/"+a.DontCodeModel.APP_REPORTS_DISPLAY_TYPE_NODE&&(t.type===a.ChangeType.DELETE?(this.dataTransformer.setConfig(),this.type=void 0):(this.dataTransformer.changeGraphType(t.value),this.type=this.dataTransformer.translatedGraphType()))}}T.\u0275fac=function(t){return new(t||T)(e.\u0275\u0275directiveInject(a.DontCodeModelManager),e.\u0275\u0275directiveInject(a.DontCodeSchemaManager))},T.\u0275cmp=e.\u0275\u0275defineComponent({type:T,selectors:[["dontcode-report-field"]],viewQuery:function(t,n){if(1&t&&e.\u0275\u0275viewQuery(F,7),2&t){let i;e.\u0275\u0275queryRefresh(i=e.\u0275\u0275loadQuery())&&(n.fullView=i.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:2,vars:0,consts:[["fullView",""],[3,"data","options","type",4,"ngIf"],[4,"ngIf"],[3,"data","options","type"]],template:function(t,n){1&t&&e.\u0275\u0275template(0,A,2,2,"ng-template",null,0,e.\u0275\u0275templateRefExtractor)},dependencies:[f.NgIf,w.UIChart,f.AsyncPipe]});class j{constructor(t,n,i,r,l){this.modelMgr=t,this.groupByColumn=n,this.affectedColumns=i,this.groupType=r,this.entityPosition=l}postLoadingTransformation(t){if(null==this.groupType.show)return t;const n=new Array,i=this.calculateFieldMapping();for(const r of t){const l=structuredClone(r);l[this.groupType.show.valueOf()]=this.calculateRelevantColumn(r,i),n.push(l)}return n}calculateRelevantColumn(t,n){let i,r,l;const m=new Map,D=this.entityPosition.subItemPointer(a.DontCodeModel.APP_FIELDS_NODE);for(const d of this.affectedColumns){let h=m.get(d);null==h&&(h=new a.DataTransformationInfo,m.set(d,h));const y=n.get(d);if(null==y)return;const u=this.modelMgr.extractValue(t[d],h,D.subItemPointer(y));null==i?(i=t[d],r=u,l=d):this.groupType.show==a.DontCodeReportGroupShowType.OnlyLowest?u<r&&(i=t[d],r=u,l=d):u>r&&(i=t[d],r=u,l=d)}return l}calculateFieldMapping(){const t=this.modelMgr.findAtPosition(this.entityPosition.position,!1),n=new Map;if(null!=t.fields)for(const i of Object.entries(t.fields))null!=i[1].name&&n.set(i[1].name,i[0]);return n}}const B=["defaultdisplay"];function N(o,t){1&o&&e.\u0275\u0275elementContainer(0)}const R=function(o){return{fieldType:o}};function L(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",6),e.\u0275\u0275template(1,N,1,0,"ng-container",7),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext();e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",i.subFieldFullViewTemplate(n))("ngTemplateOutletContext",e.\u0275\u0275pureFunction1(2,R,n.type))}}function $(o,t){1&o&&e.\u0275\u0275elementContainer(0)}function G(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",8),e.\u0275\u0275template(1,$,1,0,"ng-container",7),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext();e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",i.subFieldFullViewTemplate(n))("ngTemplateOutletContext",e.\u0275\u0275pureFunction1(2,R,n.type))}}function Q(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",3),e.\u0275\u0275template(1,L,2,4,"div",4),e.\u0275\u0275template(2,G,2,4,"div",5),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","Table"===n.type),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf","Table"!==n.type)}}function J(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"div",9),e.\u0275\u0275text(1),e.\u0275\u0275elementEnd()),2&o){const n=t.fieldType;e.\u0275\u0275advance(1),e.\u0275\u0275textInterpolate1(" No components for ",n," ")}}class v extends c.PluginBaseComponent{constructor(t,n,i,r,l,m){super(t,r,l),this.entityService=n,this.valueService=i,this.modelMgr=m,this.title="No Title",this.store=null,this.dataLoading=!1,this.reportDescription=null,this.reportEntityData=new a.DontCodeStorePreparedEntities([]),this.targetEntityPointer=null,this.fieldTypeTransformer=null,null==this.modelMgr&&(this.modelMgr=a.dtcde.getModelManager())}initCommandFlow(t,n){if(super.initCommandFlow(t,n),!this.entityPointer)throw new Error("Cannot listen to changes without knowing a base position");this.reportDescription=t.getJsonAt(this.entityPointer.position),this.initTargetEntity(),this.decomposeJsonToMultipleChanges(this.entityPointer,this.reportDescription),this.initChangeListening(!0)}initTargetEntity(){if(null==this.entityPointer)return;const t=this.valueService.findTargetOfProperty("for",this.entityPointer.position);null!=t&&null!=this.provider&&(this.targetEntityPointer=this.provider.getSchemaManager().generateSchemaPointer(t.pointer),this.store=this.entityService.retrieveListManager(this.targetEntityPointer,this.valueService.findAtPosition(t.pointer,!1)),this.pluginHelper.initOtherChangeListening(!0,this.targetEntityPointer))}ngAfterViewInit(){super.ngAfterViewInit(),this.loadTargetEntities()}loadTargetEntities(){if(!this.entityPointer||!this.provider)throw new Error("Cannot create subcomponents before initCommandFlow is called");null!=this.store&&(this.dataLoading=!0,this.calculateTransformer(),this.store.searchAndPrepareEntities(this.reportDescription?.sortedBy,this.reportDescription?.groupedBy,this.fieldTypeTransformer??void 0).then(()=>{console.debug("Loaded entities"),this.reportEntityData=this.store?.prepared??new a.DontCodeStorePreparedEntities([]),this.dataLoading=!1,this.updateSubFieldsValues(),this.ref.markForCheck(),this.ref.detectChanges()},t=>{this.dataLoading=!1}))}updateSubFieldsValues(){for(const t of this.fields)null!=t.component&&t.component.setValue(this.store)}providesTemplates(t){throw new Error("Method not implemented.")}canProvide(t){throw new Error("Method not implemented.")}setValue(t){console.debug("setValue() called for ReportEntity")}getValue(){console.debug("getValue() called for ReportEntity")}handleChange(t){t?.pointer?.positionInSchema===a.DontCodeModel.APP_REPORTS_DISPLAY?this.updateSubFieldsWithChange(t,null).then(n=>{null!=n&&(this.updateSubFieldsValues(),this.ref.markForCheck(),this.ref.detectChanges())}).catch(n=>{console.error(n)}):t?.pointer?.positionInSchema===a.DontCodeModel.APP_REPORTS_TITLE?this.title=t.type===a.ChangeType.DELETE?"":t.value:null!=this.targetEntityPointer&&null!=t?.pointer?.isSubItemOf(this.targetEntityPointer)&&this.loadTargetEntities()}subFieldFullViewTemplate(t){let n=super.subFieldFullViewTemplate(t);return null==n&&(n=this.defaultTemplate),n}calculateTransformer(){if(this.fieldTypeTransformer=null,null!=this.reportDescription&&null!=this.targetEntityPointer&&null!=this.provider&&null!=this.reportDescription.groupedBy){const t=Object.values(this.reportDescription.groupedBy)[0]?.of;if(null!=t){const n=this.valueService.findAtPosition(this.targetEntityPointer.position,!1);if(null!=n.fields){const i=new Array;for(const r of Object.values(n.fields)){if(r.name==t)return;r.type==t&&i.push(r.name)}0!=i.length&&(this.fieldTypeTransformer=new j(this.modelMgr,t,i,Object.values(this.reportDescription.groupedBy)[0],this.targetEntityPointer))}}}}}v.\u0275fac=function(t){return new(t||v)(e.\u0275\u0275directiveInject(c.ComponentLoaderService),e.\u0275\u0275directiveInject(c.EntityStoreService),e.\u0275\u0275directiveInject(c.ValueService),e.\u0275\u0275directiveInject(e.Injector),e.\u0275\u0275directiveInject(e.ChangeDetectorRef),e.\u0275\u0275directiveInject(a.DontCodeModelManager,8))},v.\u0275cmp=e.\u0275\u0275defineComponent({type:v,selectors:[["dontcode-report-entity"]],viewQuery:function(t,n){if(1&t&&e.\u0275\u0275viewQuery(B,5),2&t){let i;e.\u0275\u0275queryRefresh(i=e.\u0275\u0275loadQuery())&&(n.defaultTemplate=i.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:7,vars:2,consts:[[1,"p-fluid"],["class","field grid",4,"ngFor","ngForOf"],["defaultdisplay",""],[1,"field","grid"],["class","col-12",4,"ngIf"],["class","col-12 md:col-6",4,"ngIf"],[1,"col-12"],[4,"ngTemplateOutlet","ngTemplateOutletContext"],[1,"col-12","md:col-6"],[1,"col-12","md:col-10"]],template:function(t,n){1&t&&(e.\u0275\u0275element(0,"dtcde-dynamic"),e.\u0275\u0275elementStart(1,"h1"),e.\u0275\u0275text(2),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementStart(3,"div",0),e.\u0275\u0275template(4,Q,3,2,"div",1),e.\u0275\u0275elementEnd(),e.\u0275\u0275template(5,J,2,1,"ng-template",null,2,e.\u0275\u0275templateRefExtractor)),2&t&&(e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate1("Report ",n.title,""),e.\u0275\u0275advance(2),e.\u0275\u0275property("ngForOf",n.getSubFields()))},dependencies:[f.NgForOf,f.NgIf,f.NgTemplateOutlet,c.DynamicInsertPoint]});var S=p(11749),Y=p(72097),k=p(91083),H=p.n(k);class U{constructor(){S.Chart.register(H()),S._adapters._date.override(Y.StdDateAdapter.chartJsStandardAdapter())}getConfiguration(){return{plugin:{id:"ReportPlugin","display-name":"Implements the Dont-code standard report model.",version:"1.0.0"},"preview-handlers":[{location:{parent:a.DontCodeModel.APP_REPORTS,id:""},class:{name:"ReportEntityComponent",source:"report"}},{location:{parent:a.DontCodeModel.APP_REPORTS_DISPLAY,id:"type",values:["Table"]},class:{name:"ReportTableComponent",source:"report"}},{location:{parent:a.DontCodeModel.APP_REPORTS_DISPLAY},class:{name:"ReportDisplayComponent",source:"report"}}]}}pluginInit(t){}}var K=p(27022),W=p(46674),E=p(72655),z=p(3134),I=p(51411);const X=["fullView"];function Z(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"th",6),e.\u0275\u0275text(1),e.\u0275\u0275element(2,"p-sortIcon",7),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275propertyInterpolate1("id","header-",n.header,""),e.\u0275\u0275property("pSortableColumn",n.field),e.\u0275\u0275advance(1),e.\u0275\u0275textInterpolate1(" ",n.header," "),e.\u0275\u0275advance(1),e.\u0275\u0275property("field",n.field)}}function q(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"tr"),e.\u0275\u0275template(1,Z,3,4,"th",5),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",n)}}function ee(o,t){1&o&&e.\u0275\u0275elementContainer(0)}function te(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275template(1,ee,1,0,"ng-container",10),e.\u0275\u0275elementContainerEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext().$implicit,r=e.\u0275\u0275nextContext(2);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",r.templateOf(n,i[n.field]))}}function ne(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"span",11),e.\u0275\u0275pipe(2,"beautifier"),e.\u0275\u0275text(3),e.\u0275\u0275pipe(4,"beautifier"),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext().$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275propertyInterpolate("pTooltip",e.\u0275\u0275pipeBind1(2,2,i[n.field])),e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate(e.\u0275\u0275pipeBind2(4,4,i[n.field],50))}}function oe(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"td"),e.\u0275\u0275template(1,te,2,1,"ng-container",9),e.\u0275\u0275template(2,ne,5,7,"ng-container",9),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",n.component),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",!n.component)}}function ie(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"tr"),e.\u0275\u0275template(1,oe,3,2,"td",8),e.\u0275\u0275elementEnd()),2&o){const n=t.columns;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",n)}}function re(o,t){1&o&&e.\u0275\u0275elementContainer(0)}function ae(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"div"),e.\u0275\u0275text(2),e.\u0275\u0275template(3,re,1,0,"ng-container",10),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit,i=e.\u0275\u0275nextContext().$implicit,r=e.\u0275\u0275nextContext(4);e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate1("",n.forAggregate.operation.toString(),":\xa0"),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngTemplateOutlet",r.templateOf(i,n.value))}}function le(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275elementStart(1,"div",11),e.\u0275\u0275pipe(2,"beautifier"),e.\u0275\u0275text(3),e.\u0275\u0275pipe(4,"beautifier"),e.\u0275\u0275elementEnd(),e.\u0275\u0275elementContainerEnd()),2&o){const n=e.\u0275\u0275nextContext().$implicit;e.\u0275\u0275advance(1),e.\u0275\u0275propertyInterpolate2("pTooltip","",n.forAggregate.operation.toString(),":\xa0",e.\u0275\u0275pipeBind1(2,4,n.value),""),e.\u0275\u0275advance(2),e.\u0275\u0275textInterpolate2("",n.forAggregate.operation.toString(),":\xa0",e.\u0275\u0275pipeBind2(4,6,n.value,50),"")}}function se(o,t){if(1&o&&(e.\u0275\u0275elementContainerStart(0),e.\u0275\u0275template(1,ae,4,2,"ng-container",9),e.\u0275\u0275template(2,le,5,9,"ng-container",9),e.\u0275\u0275elementContainerEnd()),2&o){const n=t.$implicit,i=e.\u0275\u0275nextContext().$implicit,r=e.\u0275\u0275nextContext(4);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",r.isTemplate(i,n.forAggregate.operation)),e.\u0275\u0275advance(1),e.\u0275\u0275property("ngIf",!r.isTemplate(i,n.forAggregate.operation))}}function pe(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"td"),e.\u0275\u0275template(1,se,3,2,"ng-container",8),e.\u0275\u0275elementEnd()),2&o){const n=t.$implicit,i=e.\u0275\u0275nextContext(2).$implicit,r=e.\u0275\u0275nextContext(2);e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",r.retrieveGroupedByValuesFor(i[r.groupRowsBy],n.field))}}function ce(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"tr",13),e.\u0275\u0275template(1,pe,2,1,"td",8),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext().columns;e.\u0275\u0275advance(1),e.\u0275\u0275property("ngForOf",n)}}function de(o,t){if(1&o&&e.\u0275\u0275template(0,ce,2,1,"tr",12),2&o){const n=e.\u0275\u0275nextContext(2);e.\u0275\u0275property("ngIf",n.areGroupsDefined())}}function ue(o,t){if(1&o&&(e.\u0275\u0275elementStart(0,"p-table",1),e.\u0275\u0275template(1,q,2,1,"ng-template",2),e.\u0275\u0275template(2,ie,2,1,"ng-template",3),e.\u0275\u0275template(3,de,1,1,"ng-template",4),e.\u0275\u0275elementEnd()),2&o){const n=e.\u0275\u0275nextContext();e.\u0275\u0275property("value",n.cleanedTableData)("columns",n.cols)("groupRowsBy",n.groupRowsBy)}}class P extends c.PluginBaseComponent{constructor(t,n,i,r,l){super(i,l,r),this.valueService=t,this.schemaMgr=n,this.loader=i,this.ref=r,this.injector=l,this.cols=new Array,this.colsMap=new Map,this.title="",this.value=null,this.targetEntityPointer=null,this.reportPointer=null,this.cleanedTableData=[],this.groupedValuesByField=new Map,null==this.schemaMgr&&(this.schemaMgr=a.dtcde.getSchemaManager())}providesTemplates(){return new c.TemplateList(null,this.fullView,this.fullView)}canProvide(t){return new c.PossibleTemplateList(!1,!0,!0)}initCommandFlow(t,n){if(super.initCommandFlow(t,n),!this.entityPointer)throw new Error("Cannot listen to changes without knowing a base position");if(this.reportPointer=this.entityPointer.parentPointer(this.schemaMgr)?.parentPointer(this.schemaMgr)??null,null!=this.reportPointer){const i=this.valueService.findTargetOfProperty("for",this.reportPointer.position);null!=i&&(this.targetEntityPointer=this.schemaMgr.generateSchemaPointer(i.pointer),this.pluginHelper.initOtherChangeListening(!0,this.targetEntityPointer.subPropertyPointer(a.DontCodeModel.APP_FIELDS_NODE)),this.decomposeJsonToMultipleChanges(this.targetEntityPointer,i.value))}this.initChangeListening(!0),this.decomposeJsonToMultipleChanges(this.entityPointer,this.provider?.getJsonAt(this.entityPointer.position))}templateOf(t,n){if(null!=t.component){t.component.setValue(n);const i=t.component.providesTemplates(t.type).forInlineView;if(i)return i}throw new Error("No component or template to display "+t.type)}setValue(t){super.setValue(t),this.cleanedTableData=null!=t.entities?t.entities:[],this.calculateGroupedValuesByField()}handleChange(t){this.targetEntityPointer?.subPropertyPointer(a.DontCodeModel.APP_FIELDS_NODE).isParentOf(t.position,!0)?this.applyUpdatesToArrayAsync(this.cols,this.colsMap,t,null,(n,i)=>this.loadSubComponent(n,i.type,i.name).then(r=>{const l=new me(i.name,i.name,i.type);return r&&r.canProvide(i.type).forInlineView&&(l.component=r,this.applyComponentToSubField(r,i.type,i.name)),l}),this.targetEntityPointer?.subPropertyPointer(a.DontCodeModel.APP_FIELDS_NODE).position).then(n=>{this.cols=n,this.ref.markForCheck(),this.ref.detectChanges()}):null!=this.entityPointer&&"title"===t.pointer?.isSubItemOf(this.entityPointer)&&(this.title=t.type==a.ChangeType.DELETE?"":t.value)}calculateGroupedValuesByField(){if(this.groupedValuesByField.clear(),null!=this.value?.prepared?.groupedByEntities?.values){this.groupRowsBy=this.value?.prepared.groupedByEntities.groupInfo.of,null!=this.value?.prepared.groupedByEntities.groupInfo.show&&(this.groupRowsBy=this.value?.prepared.groupedByEntities.groupInfo.show.valueOf());for(const t of this.value.prepared.groupedByEntities.values.keys()){const n=this.value.prepared.groupedByEntities.values.get(t)??[];for(const i of n){let r=this.groupedValuesByField.get(t)?.get(i.forAggregate.of);if(null==r){r=new Array;let l=this.groupedValuesByField.get(t);null==l&&(l=new Map,this.groupedValuesByField.set(t,l)),l.set(i.forAggregate.of,r)}r.push(i)}}}}retrieveGroupedByValuesFor(t,n){const i=this.groupedValuesByField.get(t)?.get(n);return i??[]}isTemplate(t,n){return!(null==t.component||n==a.DontCodeGroupOperationType.Count)}areGroupsDefined(){return null!=this.groupRowsBy}}P.\u0275fac=function(t){return new(t||P)(e.\u0275\u0275directiveInject(c.ValueService),e.\u0275\u0275directiveInject(a.DontCodeSchemaManager),e.\u0275\u0275directiveInject(c.ComponentLoaderService),e.\u0275\u0275directiveInject(e.ChangeDetectorRef),e.\u0275\u0275directiveInject(e.Injector))},P.\u0275cmp=e.\u0275\u0275defineComponent({type:P,selectors:[["dontcode-report-table"]],viewQuery:function(t,n){if(1&t&&e.\u0275\u0275viewQuery(X,7),2&t){let i;e.\u0275\u0275queryRefresh(i=e.\u0275\u0275loadQuery())&&(n.fullView=i.first)}},features:[e.\u0275\u0275InheritDefinitionFeature],decls:3,vars:0,consts:[["fullView",""],["rowGroupMode","subheader",3,"value","columns","groupRowsBy"],["pTemplate","header"],["pTemplate","body"],["pTemplate","groupfooter"],[3,"id","pSortableColumn",4,"ngFor","ngForOf"],[3,"id","pSortableColumn"],[3,"field"],[4,"ngFor","ngForOf"],[4,"ngIf"],[4,"ngTemplateOutlet"],[3,"pTooltip"],["class","rowgroup-footer font-bold font-italic",4,"ngIf"],[1,"rowgroup-footer","font-bold","font-italic"]],template:function(t,n){1&t&&(e.\u0275\u0275element(0,"dtcde-dynamic"),e.\u0275\u0275template(1,ue,4,3,"ng-template",null,0,e.\u0275\u0275templateRefExtractor))},dependencies:[f.NgForOf,f.NgIf,f.NgTemplateOutlet,z.PrimeTemplate,c.DynamicInsertPoint,E.Table,E.SortableColumn,E.SortIcon,I.Tooltip,c.BeautifierPipe],styles:[".rowgroup-footer[_ngcontent-%COMP%]{background:var(--surface-100)!important}"]});class me{constructor(t,n,i){this.field=t,this.header=n,this.type=i,this.component=null}}class g{constructor(){console.log("Report Plugin registering"),a.dtcde.registerPlugin(new U)}exposedPreviewHandlers(){return new Map([["ReportEntityComponent",v],["ReportDisplayComponent",T],["ReportTableComponent",P]])}}g.\u0275fac=function(t){return new(t||g)},g.\u0275mod=e.\u0275\u0275defineNgModule({type:g,id:"dontcode-plugin/report"}),g.\u0275inj=e.\u0275\u0275defineInjector({imports:[f.CommonModule,K.ReactiveFormsModule,W.DropdownModule,w.ChartModule,c.PluginCommonModule.forRoot(),E.TableModule,I.TooltipModule]}),e.\u0275\u0275registerNgModuleType(g,"dontcode-plugin/report")}}]);